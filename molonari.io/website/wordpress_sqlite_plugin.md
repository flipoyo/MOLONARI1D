# SQLite Plugin for WordPress

We want data logs to be accessible from the website. Those are stored in a `Molonari.sqlite` database generated by the Molonaviz Python script.

This file explains how we deployed such a feature.

## Creating a plugin

With an SSH access to the VPS, we create a custom plugin for WordPress. We navigate to `/var/www/html/molonari.io/wordpress/wp-content/plugins` and create a directory `sqlite-molonaviz` in which our plugin will be hosted.

WordPress plugins are written in PHP: we create a `sqlite-molonaviz.php` file in which we write a function with the following structure:
```php
<?php
/*
Plugin Name: Custom SQLite Query
Description: Query and display data from the Molonari SQLite database.
Version: 1.0
Author: MOLONARI
*/

add_shortcode('sqlite_molonaviz', 'sqlite_molonaviz_shortcode');

function sqlite_molonaviz_shortcode() {
    // this functions should return an HTML code:

    return '<p>Hello, world!</p>'
}
?>
```

Once the file is saved, the plugin can be activated from the Dashboard.

To use the plugin, simply type in `[sqlite_molonaviz]` in a text block in the WordPress editor. Save the page: it should now output `Hello, world!`

## Deploying the database

We now have to access the data logs from this PHP function. First, we clone the repository and create a Python environment in `Molonaviz`:
```
git clone https://github.com/flipoyo/MOLONARI1D.git
cd MOLONARI1D/Molonaviz
pip install -e .
python -m src.receiver.main
```

This should create a `TestDatabase` folder and a `Molonari.sqlite` database inside. This file should be accessible from the WordPress service, i.e. `nginx`, i.e. the `www-data` user. To do so, we run `chmod +xr TestDatabase/Molonari.sqlite`.

## Accessing the database

The following code can be added to the function to query the database and display results:

```php
$db_path = '/root/MOLONARI1D/Molonaviz/TestDatabase/Molonari.sqlite';

if (!file_exists($db_path)) {
    return "Error: Database file not found.";
}

$db = new SQLite3($db_path);
if (!$db) {
    return "Error: Unable to open the database.";
}

$table_name = 'RawMeasuresTemp';

// Query to get table headers (column names)
$headers_query = "PRAGMA table_info($table_name)";
$headers_result = $db->query($headers_query);

// Fetch the column names
$headers = [];
while ($row = $headers_result->fetchArray(SQLITE3_ASSOC)) {
    $headers[] = $row['name']; // 'name' is the key for column names in PRAGMA table_info
}

$output = '
<style>
table {
    border-collapse: collapse;
    box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    width: 100%;
}
th, td {
    padding: 0.1em 0.7em;
    border: 1px solid #ddd;
}
th {
    background-color: #f2f2f2;
    color: #333;
}
tr {
    font-family: Mono;
    font-size: 0.7em;
    text-align: center;
}
tr:nth-child(even) {
    background-color: #f9f9f9;
}
tr:hover {
    background-color: #f1f1f1;
}
</style>
';

$output .= '<table><thead><tr>';
foreach ($headers as $header) {
    $output .= "<th>" . esc_html($header) . "</th>";
}
$output .= "</tr></thead>";

$data_query = "SELECT * FROM $table_name ORDER BY Date DESC LIMIT 128";
$data_result = $db->query($data_query);

$output .= "<tbody>";
while ($row = $data_result->fetchArray(SQLITE3_ASSOC)) {
    $output .= "<tr>";
    foreach ($headers as $header) {
        $str = esc_html($row[$header]);
        if ($header == 'Date') $str = date_format(date_create($row[$header]), "Y-m-d H:i:s");
        else if (str_contains($header, "Temp")) $str = round($row[$header]*100)/100;
        $output .= "<td>" . $str . "</td>";
    }
    $output .= "</tr>";
}
$output .= "</tbody></table>";

$db->close();

return $output;
```

Now, the page should display a table with the data logs.